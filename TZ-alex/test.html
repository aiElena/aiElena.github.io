<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width">
	<title>Test-JS</title>
	<link rel="stylesheet" href="css/style.css">
    <script type="application/javascript" src="hex.js"></script>
    <script type="application/javascript" src="base64.js"></script>
    <script type="application/javascript" src="oids.js"></script>
    <script type="application/javascript" src="int10.js"></script>
    <script type="application/javascript" src="asn1.js"></script>

	
	<!--[if lte IE 9 ]>
		<script type="text/javascript" src="js/PIE.js"></script>
		<script type="text/javascript" src="js/for-ie.js"></script>
		<script type="text/javascript" src="js/modernizr-1.7.min.js"></script>
		<script type="text/javascript" src="js/placeholder.js"></script>
	<![endif]-->
	
    <script type="application/javascript">
    var cert1 =`MIIFfDCCBSSgAwIBAgIUSqDuBgAAAAAAAAAAAAAAAAAAAAEwDQYLKoYkAgEBAQEDAQEwggEcMVsw
WQYDVQQDDFLQkNCm0KHQmiDQotCe0JIgItCm0LXQvdGC0YAg0YHQtdGA0YLQuNGE0ZbQutCw0YbR
ltGXINC60LvRjtGH0ZbQsiAi0KPQutGA0LDRl9C90LAiMREwDwYDVQQHDAjQmtC40ZfQsjEZMBcG
A1UEBQwQVUEtMzY4NjU3NTMtMDExNzFSMFAGA1UECgxJ0KLQntCSICLQptC10L3RgtGAINGB0LXR
gNGC0LjRhNGW0LrQsNGG0ZbRlyDQutC70Y7Rh9GW0LIgItCj0LrRgNCw0ZfQvdCwIjEuMCwGA1UE
Cwwl0JLRltC00LTRltC7INGB0LXRgNGC0LjRhNGW0LrQsNGG0ZbRlzELMAkGA1UEBgwCVUEwHhcN
MTgxMjE3MDk1OTM0WhcNMjAxMjE2MjE1OTU5WjCCAVIxWDBWBgNVBAMMT9CQ0JTQktCe0JrQkNCi
0KHQrNCa0JUg0J7QkSfQhNCU0J3QkNCd0J3QryAi0JzQkNCd0JTQoNCY0Jog0IYg0J/QkNCg0KLQ
ndCV0KDQmCIxFzAVBgNVBAgMDtCe0JTQldCh0KzQmtCQMRMwEQYDVQQHDArQntCU0JXQodCQMQ4w
DAYDVQQRDAU2NTAxMjE+MDwGA1UECQw10LLRg9C70LjRhtGPINCc0LDQu9CwINCQ0YDQvdCw0YPR
gtGB0YzQutCwLCDQsdGD0LQuIDQxETAPBgNVBAUMCDM4NzIzMzk5MVgwVgYDVQQKDE/QkNCU0JLQ
ntCa0JDQotCh0KzQmtCVINCe0JEn0ITQlNCd0JDQndCd0K8gItCc0JDQndCU0KDQmNCaINCGINCf
0JDQoNCi0J3QldCg0JgiMQswCQYDVQQGDAJVQTBGMB4GCyqGJAIBAQEBAwEBMA8GDSqGJAIBAQEB
AwEBAgYDJAAEIT3BR+U64qChBXC4q8DNflTDJUFQFjkYfNHtl0hot89MAaOCAhgwggIUMCUGA1Ud
CQQeMBwwGgYMKoYkAgEBAQsBBAIBMQoTCDM4NzIzMzk5MCAGA1UdEQQZMBeBFW9kZXNzYV9va3Nh
bmFAdWtyLm5ldDApBgNVHQ4EIgQgQWQ+rzioB1kKDuj9ZtYJB1GvVIalErGZcecgohKjSNUwKwYD
VR0jBCQwIoAglMZXd3JNqwwii2ttuh3dYl4Hdu9akUrJ5bjDdLJ7GF4wDgYDVR0PAQH/BAQDAgDA
MBQGA1UdJQQNMAsGCSqGJAIBAQEDCTAZBgNVHSABAf8EDzANMAsGCSqGJAIBAQECAjAeBggrBgEF
BQcBAwEB/wQPMA0wCwYJKoYkAgEBAQIBMDMGA1UdLgQsMCowKKAmoCSGImh0dHA6Ly91YWtleS5j
b20udWEvbGlzdC1kZWx0YS5jcmwwLQYDVR0fBCYwJDAioCCgHoYcaHR0cDovL3Vha2V5LmNvbS51
YS9saXN0LmNybDA9BggrBgEFBQcBCwQxMC8wLQYIKwYBBQUHMAOGIWh0dHA6Ly91YWtleS5jb20u
dWEvc2VydmljZXMvdHNwLzBtBggrBgEFBQcBAQRhMF8wLQYIKwYBBQUHMAKGIWh0dHA6Ly91YWtl
eS5jb20udWEvdWFrZXljZXJ0LnA3YjAuBggrBgEFBQcwAYYiaHR0cDovL3Vha2V5LmNvbS51YS9z
ZXJ2aWNlcy9vY3NwLzANBgsqhiQCAQEBAQMBAQNDAARAIt1xk3d0alIMVgK56S3e/I6mMMaW90jc
aHzAgGkrwFaVWwbBnKwHNOepYI9XTjDtQ8s1gixXdBD05wvmxqf3HQ==`
function Parser(Asn1,Base64){
  return class Asn{
     constructor(cert){
        if(typeof cert === "object" && cert!==null){
	   this._load(cert);
	}else{
	   this._parse(cert);
	}
     }	     
     _parse(cert){
        var result = Asn1.decode(cert);
        if (result.typeName() !== 'SEQUENCE') {
          result = Asn1.decode(Base64.decode(cert));
	}	
        if (result.typeName() === 'SEQUENCE') {
          var tbsCertificate = result.sub[0];
          var version = tbsCertificate.sub[0].sub[0].content();
          this.assert('Version', version=='2');
          var serialNumber = tbsCertificate.sub[1].content();
          var issuerCommonNameAttr= tbsCertificate.sub[3].sub[0].sub[0].sub[0].content();
          this.assert('Issuer Common Name', issuerCommonNameAttr=='2.5.4.3\ncommonName\nX.520 DN component');
          var issuerCommonNameVal= tbsCertificate.sub[3].sub[0].sub[0].sub[1].content();
          var validFrom = tbsCertificate.sub[4].sub[0].content();
          var validTo = tbsCertificate.sub[4].sub[1].content();
          var commonNameAttr= tbsCertificate.sub[5].sub[0].sub[0].sub[0].content();
          this.assert('Common Name', commonNameAttr=='2.5.4.3\ncommonName\nX.520 DN component');
          var commonNameVal= tbsCertificate.sub[5].sub[0].sub[0].sub[1].content();
          this.cert = {
             version, 
             serialNumber,
             issuerCommonNameAttr,
             issuerCommonNameVal,
             validFrom,
             validTo,
             commonNameAttr,
             commonNameVal,
            };
        }
      }
      _load(cert){
              this.assert('Version', cert.version=='2');
	      this.assert('Issuer Common Name', cert.issuerCommonNameAttr=='2.5.4.3\ncommonName\nX.520 DN component');
              this.assert('Common Name', cert.commonNameAttr=='2.5.4.3\ncommonName\nX.520 DN component');
	      this.cert = Object.assign({},cert);
     };
     	  
     get serialNumber(){
        return this.cert.serialNumber;
     }
     get commonName(){
	return this.cert.commonNameVal;
     }
     toJSON(){
        return this.cert;
     }	  
     assert(Label, predicate){
       if(!predicate){
         throw 'Invalid '+ Label;
       }
     }
    
     toString(){
return `Common Name: ${this.cert.commonNameVal}
 Issuer CN: ${this.cert.issuerCommonNameVal}
 Valid From: ${this.cert.validFrom}
 Valid To: ${this.cert.validTo}
`;
     }
  }
}  

    </script>
    
    <script type="application/javascript">
     document.addEventListener("DOMContentLoaded", function() {
       var pannel = document.getElementsByClassName('pannel')[0];
       let button = document.getElementsByClassName('button')[0];
       let ul = document.getElementsByClassName('certlist')[0];
       var drag = false;
       var Cert = Parser(ASN1,Base64);
       var certs = [];
       var index ={};
       	     
       //append(new Cert(cert1));
       load(localStorage,"certs");	     
       function load(store, storeKey){
         var data = store.getItem(storeKey);
	 var list;      
	 if(data){
	    list = JSON.parse(data);
            for(let cert of list){
	       append(new Cert(cert));
	    }
	 }
       }
       function save(store, storeKey, certs){
          store.setItem(storeKey,JSON.stringify(certs));
       }
       button.addEventListener('click', function(){
	   setDrag(!drag);  
       })
       pannel.addEventListener('dragover',function(e){
	  e.preventDefault();
	  e.stopPropagation();     
	  e.dataTransfer.dropEffect = (drag)?"copy":"none";
	  return false;     
       },false);
       pannel.addEventListener('drop',function(e){
          
	  e.preventDefault();
	  e.stopPropagation();
	  if(drag){     
	  var file = e.dataTransfer.files[0],
          reader = new FileReader();
          reader.onload = function (event) {
             var c = new Cert(event.target.result);
		  if(append(c)){
		    save(localStorage,"certs",certs);
		  };
		setDrag(false);
		print(c);  
	     }
          };
	  reader.readAsBinaryString(file);
       },false)
       ul.addEventListener('click',function(e){
         setDrag(false);
	 var ind = Array.prototype.indexOf.call(this.children, e.target);
         print(certs[ind]);
	       
       })
       function print(c){
          pannel.innerText=c.toString();     
       }
       function setDrag(val){
           drag = val;
	   button.value = (drag)?'Отменить':'Добавить';
	   pannel.className='pannel pannel_dragable-'.concat((drag)?'true':'false');
	   if(drag){
             pannel.innerText='';
	   } 
       }
       function append(c){
	 if(index[c.serialNumber]===undefined){
	    index[c.serialNumber]=certs.push(c)-1;
	       
            var li = document.createElement('LI');
	    li.innerText=c.commonName;
	    ul.appendChild(li);
            return true;		 
          }
	  return false;     
       }
    });
    </script>

</head>
<body>
    <div class="my-flex-block">
		<div class="item_left">
			<div class="inf">		
				<ul class="certlist">
				</ul>
				<input type="button" value="Добавить" class="button">
			</div>			
		</div>
		<div class="item_right">
			<div class="pannel pannel_dragable-false"></div>
		</div>
	</div>
</body>
</html>
